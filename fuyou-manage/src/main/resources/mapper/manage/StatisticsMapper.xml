<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dkd.manage.mapper.StatisticsMapper">

    <!-- 按工单类型统计工单数据 -->
    <select id="selectTaskStatsByType" resultType="map">
        SELECT
        tt.type as task_type,
        tt.type_name,
        COUNT(*) as total,
        COUNT(DISTINCT t.user_id) as worker_count,
        SUM(CASE WHEN t.task_status = 4 THEN 1 ELSE 0 END) as completed_total,
        SUM(CASE WHEN t.task_status = 3 THEN 1 ELSE 0 END) as cancel_total,
        SUM(CASE WHEN t.task_status IN (1, 2) THEN 1 ELSE 0 END) as progress_total
        FROM tb_task t
        INNER JOIN tb_task_type tt ON t.product_type_id = tt.type_id
        WHERE tt.type IN (1, 2)
        <if test="start != null and end != null">
            AND t.create_time BETWEEN #{start} AND #{end}
        </if>
        GROUP BY tt.type, tt.type_name
        ORDER BY tt.type
    </select>

    <!-- 销售统计（订单量、销售额） -->
    <select id="selectSalesStats" resultType="map">
        SELECT
        COUNT(*) as orderCount,
        COALESCE(SUM(amount), 0) as orderAmount
        FROM tb_order
        WHERE status = 2
        <if test="beginTime != null and endTime != null">
            <![CDATA[
            AND create_time >= CONCAT(#{beginTime}, ' 00:00:00')
            AND create_time < DATE_ADD(CONCAT(#{endTime}, ' 00:00:00'), INTERVAL 1 DAY)
            ]]>
        </if>
    </select>

    <!-- 商品销售排行（TopN） -->
    <select id="selectSkuSaleRank" resultType="map">
        SELECT
        sku_id,
        MAX(sku_name) as skuName,
        COUNT(*) as count,
        COALESCE(SUM(amount), 0) as amount
        FROM tb_order
        WHERE status = 2
        <if test="beginTime != null and endTime != null">
            <![CDATA[
            AND create_time >= CONCAT(#{beginTime}, ' 00:00:00')
            AND create_time < DATE_ADD(CONCAT(#{endTime}, ' 00:00:00'), INTERVAL 1 DAY)
            ]]>
        </if>
        GROUP BY sku_id
        ORDER BY count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 销售趋势（按日或按月） -->
    <select id="selectSalesTrend" resultType="map">
        SELECT
        <choose>
            <when test="granularity == 'month'">
                DATE_FORMAT(create_time, '%Y-%m') as date_key,
            </when>
            <otherwise>
                DATE_FORMAT(create_time, '%Y-%m-%d') as date_key,
            </otherwise>
        </choose>
        COALESCE(SUM(amount), 0) as amount
        FROM tb_order
        WHERE status = 2
        <if test="beginTime != null and endTime != null">
            <![CDATA[
            AND create_time >= CONCAT(#{beginTime}, ' 00:00:00')
            AND create_time < DATE_ADD(CONCAT(#{endTime}, ' 00:00:00'), INTERVAL 1 DAY)
            ]]>
        </if>
        GROUP BY date_key
        ORDER BY date_key
    </select>

    <!-- 按产品类别的销售趋势（多序列） -->
    <select id="selectSalesTrendByClass" resultType="map">
        SELECT
        COALESCE(class_id, 0) as class_id,
        <choose>
            <when test="granularity == 'month'">
                DATE_FORMAT(create_time, '%Y-%m') as date_key,
            </when>
            <otherwise>
                DATE_FORMAT(create_time, '%Y-%m-%d') as date_key,
            </otherwise>
        </choose>
        COALESCE(SUM(amount), 0) as amount
        FROM tb_order
        WHERE status = 2
        <if test="beginTime != null and endTime != null">
            <![CDATA[
            AND create_time >= CONCAT(#{beginTime}, ' 00:00:00')
            AND create_time < DATE_ADD(CONCAT(#{endTime}, ' 00:00:00'), INTERVAL 1 DAY)
            ]]>
        </if>
        GROUP BY class_id, date_key
        ORDER BY class_id, date_key
    </select>

    <!-- 销售区域分布（TopN） -->
    <select id="selectSalesRegionDistribution" resultType="map">
        SELECT
        t.region_key,
        t.amount
        FROM (
        SELECT
        COALESCE(region_name, addr, '未知区域') as region_key,
        COALESCE(SUM(amount), 0) as amount
        FROM tb_order
        WHERE status = 2
        <if test="beginTime != null and endTime != null">
            <![CDATA[
                AND create_time >= CONCAT(#{beginTime}, ' 00:00:00')
                AND create_time < DATE_ADD(CONCAT(#{endTime}, ' 00:00:00'), INTERVAL 1 DAY)
                ]]>
        </if>
        GROUP BY COALESCE(region_name, addr, '未知区域')
        ) t
        ORDER BY t.amount DESC
        <if test="topN != null">
            LIMIT #{topN}
        </if>
    </select>

    <!-- 销售区域分布（按月） -->
    <select id="selectSalesRegionDistributionByMonth" resultType="map">
        SELECT
        DATE_FORMAT(create_time, '%Y-%m') as date_key,
        COALESCE(SUM(amount), 0) as amount
        FROM tb_order
        WHERE status = 2
        <if test="beginTime != null and endTime != null">
            <![CDATA[
            AND create_time >= CONCAT(#{beginTime}, ' 00:00:00')
            AND create_time < DATE_ADD(CONCAT(#{endTime}, ' 00:00:00'), INTERVAL 1 DAY)
            ]]>
        </if>
        GROUP BY date_key
        ORDER BY date_key
    </select>

    <!-- 合作商点位统计（TopN） -->
    <select id="selectPartnerNodeStats" resultType="map">
        <!-- 修复：tb_partner 主键为 id，原 SQL 使用 p.partner_id 导致 Unknown column 错误 -->
        SELECT
        t.partner_name,
        t.node_count
        FROM (
        SELECT
        COALESCE(p.partner_name, '未知合作商') as partner_name,
        COUNT(*) as node_count
        FROM tb_node n
        LEFT JOIN tb_partner p ON n.partner_id = p.id
        GROUP BY n.partner_id, p.partner_name
        ) t
        ORDER BY t.node_count DESC
        <if test="topN != null">
            LIMIT #{topN}
        </if>
    </select>

    <!-- 合作商点位汇总统计 -->
    <select id="selectPartnerNodeSummary" resultType="map">
        SELECT
            COALESCE(COUNT(*), 0) as total_nodes,
            COALESCE(COUNT(DISTINCT partner_id), 0) as partner_count
        FROM tb_node
    </select>

    <!-- 异常设备列表（包含工单状态） -->
    <select id="selectAbnormalEquipmentWithTaskStatus" resultType="com.dkd.manage.domain.vo.VendingMachineVO">
        <!-- 修复：显式统一 inner_code 的排序规则，避免 MySQL8 不同排序规则 '=' 比较引发 1267 错误 -->
        SELECT
        vm.id,
        vm.inner_code,
        vm.channel_max_capacity,
        vm.node_id,
        vm.addr,
        vm.last_supply_time,
        vm.business_type,
        vm.region_id,
        vm.partner_id,
        vm.vm_type_id,
        vm.vm_status,
        vm.running_status,
        vm.longitudes,
        vm.latitude,
        vm.client_id,
        vm.policy_id,
        vm.create_time,
        vm.update_time,
        latest_task.task_status,
        CASE
        WHEN latest_task.task_status IN (1, 2) THEN 1
        ELSE 0
        END as hasActiveTask
        FROM tb_vending_machine vm
        LEFT JOIN (
        SELECT
        t1.inner_code,
        t1.task_status
        FROM tb_task t1
        INNER JOIN (
        SELECT inner_code, MAX(task_id) as max_task_id
        FROM tb_task
        GROUP BY inner_code
        ) t2 ON t1.inner_code = t2.inner_code AND t1.task_id = t2.max_task_id
        ) latest_task ON vm.inner_code COLLATE utf8mb4_unicode_ci = latest_task.inner_code COLLATE utf8mb4_unicode_ci
        WHERE vm.vm_status IN (0, 2)
        AND (latest_task.task_status IS NULL OR latest_task.task_status != 4)
        ORDER BY vm.update_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>
